<section class="mx-auto max-w-6xl space-y-6" [formGroup]="placeForm">
  <div class="space-y-4">
    <h2 class="text-sm font-semibold text-primary-900 dark:text-primary-50">Mandatory Information</h2>

    <div class="grid grid-cols-2 gap-4">
      <div class="relative col-span-2">
        <p-floatlabel variant="in">
          <input id="name" formControlName="name" pInputText autofocus fluid (keydown.enter)="completionSearchText()" />
          <label for="name">Name</label>
        </p-floatlabel>
        <div class="absolute right-3 top-1/2 -translate-y-1/2 rounded-lg">
          <p-button [disabled]="!placeForm.get('name')!.value" text label="Query" icon="pi pi-sparkles" size="small"
            pTooltip="Complete using Provider API" (click)="completionSearchText()"
            class="cursor-pointer text-primary-400 hover:text-primary-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" />
        </div>
      </div>

      <p-floatlabel variant="in">
        <input id="lat" formControlName="lat" pInputText fluid />
        <label for="lat">Latitude</label>
      </p-floatlabel>

      <p-floatlabel variant="in">
        <input id="lng" formControlName="lng" pInputText fluid />
        <label for="lng">Longitude</label>
      </p-floatlabel>
    </div>

    <div class="grid md:grid-cols-4 items-start gap-4">
      <div class="md:col-span-3">
        <p-floatlabel variant="in">
          <input id="place" aria-describedby="username-help" formControlName="place" pInputText fluid />
          <label for="place">Place</label>
        </p-floatlabel>
        <span class="select-none text-xs text-primary-500">Supports <i>google.com/maps/place/</i> and
          <i>https://maps.app.goo.gl</i> (Google API Key required)</span>
      </div>

      <div>
        <p-floatlabel variant="in">
          <p-select [options]="(categories$ | async) || []" optionValue="id" optionLabel="name" appendTo="body"
            [loading]="!(categories$ | async)?.length" inputId="category" formControlName="category" [checkmark]="true"
            fluid>
            <ng-template let-category #item>
              <div class="capitalize whitespace-normal">{{ category.name }}</div>
            </ng-template>
          </p-select>
          <label for="category">Category</label>
        </p-floatlabel>
      </div>
    </div>
  </div>

  <div class="space-y-4">
    <h2 class="text-sm font-semibold text-primary-900 dark:text-primary-50">Additional Details</h2>
    <div class="grid md:grid-cols-[auto_1fr] gap-4">
      <div
        class="flex flex-col items-center justify-center gap-2 p-4 bg-primary-50 dark:bg-black rounded-lg border border-primary-200 dark:border-primary-700">
        <div class="relative group">
          @if (placeForm.get('image_id')?.value || placeForm.get('image')?.value) {
          <img [src]="placeForm.get('image')?.value || '/favicon.png'"
            class="size-24 object-cover rounded-lg shadow ring-2 ring-primary-200 dark:ring-primary-700 cursor-pointer transition-all group-hover:ring-primary-400"
            (click)="imageInput.click()" />
          <div
            class="absolute inset-0 bg-black/60 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
            (click)="imageInput.click()">
            <i class="pi pi-camera text-white text-2xl"></i>
          </div>
          @if (!placeForm.get('image_id')?.value) {
          <button type="button"
            class="cursor-pointer absolute -top-2 -right-2 size-7 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow transition"
            (click)="clearImage(); $event.stopPropagation()">
            <i class="pi pi-times text-xs"></i>
          </button>
          }
          } @else {
          <div
            class="size-24 flex items-center justify-center bg-primary-100 dark:bg-primary-900 rounded-lg border-2 border-dashed border-primary-300 dark:border-primary-600 cursor-pointer transition hover:border-primary-400"
            (click)="imageInput.click()">
            <i class="pi pi-image text-3xl text-primary-400"></i>
          </div>
          }
          <input type="file" accept="image/*" #imageInput class="hidden" (change)="onImageSelected($event)" />
        </div>
        <p-button icon="pi pi-link" label="URL" severity="secondary" size="small" text
          (click)="showImageUrlDialog = true" />
      </div>

      <div class="space-y-4">
        <div
          class="flex flex-wrap gap-4 p-3 bg-primary-50 dark:bg-black/20 rounded-lg border border-primary-200 dark:border-primary-700">
          <button (click)="toggleCheckbox('allowdog')"
            class="select-none cursor-pointer inline-flex items-center gap-2 h-8 w-36 max-w-[25vw] px-3 rounded-lg text-sm font-medium transition-all"
            [class]="
              placeForm.get('allowdog')?.value
                ? 'bg-emerald-600 text-white'
                : 'bg-primary-100 dark:bg-black text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-800'
            ">
            @if (placeForm.get('allowdog')?.value) {
            <i class="pi pi-check text-xs"></i>
            } @else {
            <span>üê∂</span>
            }
            <span class="truncate">Dog-friendly</span>
          </button>

          <button (click)="toggleCheckbox('restroom')"
            class="select-none cursor-pointer inline-flex items-center gap-2 h-8 w-24 max-w-[25vw] px-3 rounded-lg text-sm font-medium transition-all"
            [class]="
              placeForm.get('restroom')?.value
                ? 'bg-sky-400 text-white'
                : 'bg-primary-100 dark:bg-black text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-800'
            ">
            @if (placeForm.get('restroom')?.value) {
            <i class="pi pi-check text-xs"></i>
            } @else {
            <span>üöΩ</span>
            }
            <span class="truncate">Toilets</span>
          </button>

          <button (click)="toggleCheckbox('visited')"
            class="select-none cursor-pointer inline-flex items-center gap-2 h-8 w-24 max-w-[25vw] px-3 rounded-lg text-sm font-medium transition-all"
            [class]="
              placeForm.get('visited')?.value
                ? 'bg-blue-600 text-white'
                : 'bg-primary-100 dark:bg-black text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-800'
            ">
            @if (placeForm.get('visited')?.value) {
            <i class="pi pi-check text-xs"></i>
            } @else {
            <i class="pi pi-eye text-xs"></i>
            }
            <span class="truncate">Visited</span>
          </button>

          <div class="flex items-center gap-2">
            @if (placeForm.get('gpx')?.value) {
            <p-button icon="pi pi-check" styleClass="hover:border-red-500! hover:bg-red-500! dark:hover:bg-red-900/40!"
              label="GPX" severity="success" size="small" (click)="clearGPX()" />
            } @else {
            <p-button icon="pi pi-paperclip" label="GPX" severity="secondary" size="small" (click)="gpxInput.click()" />
            }
            <input type="file" accept=".gpx" #gpxInput class="hidden" (change)="onGPXSelected($event)" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <p-floatlabel variant="in">
            <p-inputnumber id="duration" formControlName="duration" mode="decimal" fluid />
            <label for="duration">Duration (minutes)</label>
          </p-floatlabel>

          <p-floatlabel variant="in">
            <p-inputnumber id="price" formControlName="price" mode="decimal" [minFractionDigits]="0"
              [maxFractionDigits]="2" fluid />
            <label for="price">Price</label>
          </p-floatlabel>
        </div>

        <div class="relative">
          <textarea pTextarea id="description" placeholder="Description" formControlName="description" rows="4"
            #descriptionInput fluid class="pr-12!"></textarea>
          @if (descriptionInput.value) {
          <p-button text icon="pi pi-times" severity="danger" class="absolute right-2 top-2"
            (click)="placeForm.get('description')?.setValue(''); placeForm.markAsDirty()" pTooltip="Clear" />
          }
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-end gap-3 pt-4 border-t border-primary-200 dark:border-primary-700">
    <p-button [label]="placeForm.get('id')?.value !== -1 ? 'Update' : 'Create'" icon="pi pi-check"
      [disabled]="!placeForm.dirty || !placeForm.valid" (click)="closeDialog()" />
  </div>
</section>

<p-dialog [(visible)]="showImageUrlDialog" appendTo="body" header="Add Image URL" [modal]="true"
  [style]="{ width: '450px' }" [draggable]="false" [resizable]="false">
  <div class="py-4">
    <p-floatlabel variant="in">
      <input id="imageUrl" type="url" [(ngModel)]="imageUrl" pInputText fluid />
      <label for="imageUrl">Image URL</label>
    </p-floatlabel>
  </div>
  <ng-template #footer>
    <p-button label="Cancel" severity="secondary" [outlined]="true"
      (click)="showImageUrlDialog = false; imageUrl = ''" />
    <p-button label="Add" [disabled]="!imageUrl" (click)="setImageFromUrl()" />
  </ng-template>
</p-dialog>