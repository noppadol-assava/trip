<section class="mx-auto max-w-5xl space-y-6" [formGroup]="itemForm">
  <div class="space-y-4">
    <h2 class="text-sm font-semibold text-primary-900 dark:text-primary-50">Mandatory Information</h2>

    <div class="grid md:grid-cols-12 gap-4">
      <div class="md:col-span-3">
        @if (itemForm.get('id')?.value !== -1) {
        <p-floatlabel variant="in">
          <p-select [options]="trip?.days" optionValue="id" optionLabel="label" inputId="day_id"
            formControlName="day_id" scrollHeight="320px" appendTo="body" [checkmark]="true" [filter]="true" fluid>
            <ng-template let-day #item>
              <div class="whitespace-normal">{{ day.label }}</div>
            </ng-template>
          </p-select>
          <label for="day_id">Day</label>
        </p-floatlabel>
        } @else {
        <p-floatlabel variant="in">
          <p-multiselect [options]="trip?.days" optionValue="id" optionLabel="label" formControlName="day_id"
            [showToggleAll]="false" display="chip" scrollHeight="320px" appendTo="body"
            selectedItemsLabel="{0} days selected" fluid>
            <ng-template let-day #item>
              <div class="whitespace-normal">{{ day.label }}</div>
            </ng-template>
          </p-multiselect>
          <label>Days</label>
        </p-floatlabel>
        }
      </div>

      <div class="md:col-span-2">
        <p-floatlabel variant="in">
          <p-inputmask id="time" formControlName="time" mask="99?:99" fluid />
          <label for="time">Time</label>
        </p-floatlabel>
      </div>

      <div class="relative md:col-span-7">
        <p-floatlabel variant="in">
          <input id="text" formControlName="text" #textInput pInputText fluid />
          <label for="text">Plan Text</label>
        </p-floatlabel>

        @if (textInput.value) {
        <p-button text icon="pi pi-times" size="small" severity="danger"
          class="absolute right-2 top-1/2 -translate-y-1/2" (click)="itemForm.get('text')?.setValue('')" />
        }
      </div>
    </div>
  </div>

  <div class="space-y-4">
    <h2 class="text-sm font-semibold text-primary-900 dark:text-primary-50">Additional Details</h2>

    <div class="grid md:grid-cols-5 gap-4">
      <p-floatlabel variant="in" class="md:col-span-3">
        <p-select [options]="places" appendTo="body" optionValue="id" optionLabel="name" inputId="place" [filter]="true"
          filterBy="name" formControlName="place" [showClear]="true" fluid>
          <ng-template let-place #item>
            <div class="flex items-center gap-2" [class.text-primary-500]="place.placeUsage">
              <img [src]="place.image || place.category.image" class="rounded-md size-6 object-cover" />
              <div>{{ place.name }}</div>
            </div>
          </ng-template>
          <ng-template let-selected #selectedItem>
            @if (selected) {
            <div class="flex items-center gap-2">
              <img [src]="selected.image || selected.category.image" class="rounded-md size-5 object-cover" />
              <div>{{ selected.name }}</div>
            </div>
            }
          </ng-template>
        </p-select>
        <label for="place">Place</label>
      </p-floatlabel>

      <p-floatlabel variant="in" class="md:col-span-2">
        <p-select [options]="statuses" optionValue="label" optionLabel="label" inputId="status" formControlName="status"
          [checkmark]="true" [showClear]="true" fluid class="capitalize">
          <ng-template let-option #item>
            <div class="flex items-center gap-2">
              <div class="size-3 rounded-full" [style.background]="option.color"></div>
              <div>{{ option.label }}</div>
            </div>
          </ng-template>
          <ng-template let-selected #selectedItem>
            @if (selected) {
            <div class="flex items-center gap-2">
              <div class="size-3 rounded-full" [style.background]="selected.color"></div>
              <div>{{ selected.label }}</div>
            </div>
            }
          </ng-template>
        </p-select>
        <label for="status">Status</label>
      </p-floatlabel>

      <p-floatlabel variant="in" class="md:col-span-2">
        <input id="lat" formControlName="lat" pInputText fluid />
        <label for="lat">Latitude</label>
      </p-floatlabel>

      <p-floatlabel variant="in" class="md:col-span-2">
        <input id="lng" formControlName="lng" pInputText fluid />
        <label for="lng">Longitude</label>
      </p-floatlabel>

      <p-inputgroup class="h-full">
        <p-floatlabel variant="in">
          <p-inputnumber id="price" formControlName="price" mode="decimal" [minFractionDigits]="0"
            [maxFractionDigits]="2" currency="EUR" locale="fr-FR" fluid />
          <label for="price">Price</label>
        </p-floatlabel>
        @if (members.length > 1) {
        <p-inputgroup-addon>
          <p-button [icon]="itemForm.get('paid_by')?.value ? 'pi pi-user-plus' : 'pi pi-users'"
            [severity]="itemForm.get('paid_by')?.value ? 'primary' : 'secondary'" class="h-full"
            [text]="!itemForm.get('paid_by')?.value" (onClick)="togglePriceMembersPopover($event)" />
        </p-inputgroup-addon>
        }
      </p-inputgroup>
    </div>

    <div class="grid md:grid-cols-[auto_1fr] gap-4">
      <div
        class="flex flex-col items-center justify-center gap-2 p-4 bg-primary-50 dark:bg-primary-800 rounded-lg border border-primary-200 dark:border-primary-700">
        <div class="relative group">
          @if (itemForm.get('image_id')?.value || itemForm.get('image')?.value) {
          <img [src]="itemForm.get('image')?.value || '/favicon.png'"
            class="size-24 object-cover rounded-lg shadow ring-2 ring-primary-200 dark:ring-primary-700 cursor-pointer transition-all group-hover:ring-primary-400"
            (click)="imageInput.click()" />
          <div
            class="absolute inset-0 bg-black/60 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
            (click)="imageInput.click()">
            <i class="pi pi-camera text-white text-2xl"></i>
          </div>

          <button type="button"
            class="cursor-pointer absolute -top-2 -right-2 size-7 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow transition"
            (click)="clearImage(); $event.stopPropagation()">
            <i class="pi pi-times text-xs"></i>
          </button>
          } @else {
          <div
            class="size-24 flex items-center justify-center bg-primary-100 dark:bg-primary-900 rounded-lg border-2 border-dashed border-primary-300 dark:border-primary-600 cursor-pointer transition hover:border-primary-400"
            (click)="imageInput.click()">
            <i class="pi pi-image text-3xl text-primary-400"></i>
          </div>
          }
          <input type="file" accept="image/*" #imageInput class="hidden" (change)="onImageSelected($event)" />
        </div>
      </div>

      <div class="space-y-4">
        <div class="grid md:grid-cols-3 gap-4">
          <div
            class="flex flex-wrap gap-4 p-3 bg-primary-50 dark:bg-primary-800 rounded-lg border border-primary-200 dark:border-primary-700">
            <div class="flex items-center gap-2">
              @if (itemForm.get('gpx')?.value) {
              <p-button icon="pi pi-check"
                styleClass="hover:border-red-500! hover:bg-red-500! dark:hover:bg-red-900/40!" label="GPX"
                severity="success" size="small" (click)="clearGPX()" />
              } @else {
              <p-button icon="pi pi-paperclip" label="GPX" severity="secondary" size="small"
                (click)="gpxInput.click()" />
              }
              <input type="file" accept=".gpx" #gpxInput class="hidden" (change)="onGPXSelected($event)" />
            </div>
          </div>

          <p-floatlabel variant="in" class="md:col-span-2">
            <p-multiselect [options]="trip?.attachments ?? []" optionValue="id" optionLabel="filename" class="h-full"
              formControlName="attachments" [showToggleAll]="false" display="chip" scrollHeight="320px" appendTo="body"
              fluid>
              <ng-template #footer>
                <div class="p-2 border-t border-primary-200 dark:border-primary-700">
                  <p-button (click)="fileUpload.click()" icon="pi pi-plus" label="Upload New" text size="small" fluid />
                  <input type="file" class="hidden" (change)="onFileUploadInputChange($event)" #fileUpload />
                </div>
              </ng-template>
            </p-multiselect>
            <label for="attachments">Attachments</label>
          </p-floatlabel>
        </div>

        <div class="relative">
          <p-floatlabel variant="in">
            <textarea pTextarea id="comment" formControlName="comment" rows="4" #descriptionInput fluid
              class="pr-12!"></textarea>
            <label for="comment">Comment</label>
          </p-floatlabel>
          @if (descriptionInput.value) {
          <p-button text icon="pi pi-times" severity="danger" class="absolute right-2 top-2"
            (click)="itemForm.get('comment')?.setValue(''); itemForm.markAsDirty()" />
          }
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-end gap-3 pt-4 border-t border-primary-200 dark:border-primary-700">
    <p-button [label]="itemForm.get('id')?.value !== -1 ? 'Update Item' : 'Create Item'" icon="pi pi-check"
      [disabled]="!itemForm.dirty || !itemForm.valid" (click)="closeDialog()" />
  </div>
</section>

<p-popover #op>
  <div class="flex flex-col gap-1 w-48">
    <span class="text-xs font-semibold text-primary-500 px-2 mb-1">Paid By</span>
    @for (member of members; track member.user) {
    <button
      class="flex items-center justify-between w-full p-2 hover:bg-primary-100 dark:hover:bg-primary-800 rounded-md text-sm transition-colors text-left"
      (click)="selectPriceMember(member.user)">
      <span>{{ member.user }}</span>
      @if (itemForm.get('paid_by')?.value == member.user) {
      <i class="pi pi-check text-primary-500 text-xs"></i>
      }
    </button>
    }
  </div>
</p-popover>